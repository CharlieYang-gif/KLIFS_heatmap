<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Kinase IFP Heatmap Tool_V3_Final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem 2rem; background: #f5f5f5; color: #333; }
    .panel { background: #fff; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #1f7ae0; margin-top: 0; }
    .flex-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .field { margin-bottom: 0.5rem; }
    label { font-weight: 600; display: block; margin-bottom: 4px; }
    input, select, textarea { padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc; font-size: 0.9rem; }
    button { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; cursor: pointer; background: #1f7ae0; color: white; font-weight: 600; transition: 0.2s; }
    button:hover { background: #155cb0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #heatmap { width: 100%; min-height: 600px; margin-top: 1rem; border: 1px solid #eee; }
    table { border-collapse: collapse; width: 100%; display: block; max-height: 400px; overflow: auto; border: 1px solid #ddd; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; text-align: center; }
    th { background: #f8f9fa; position: sticky; top: 0; }
    .dual-list-container { display: flex; gap: 1rem; margin-top: 1rem; }
    .dual-list-column { flex: 1; display: flex; flex-direction: column; }
    .dual-list-select { min-height: 250px; width: 100%; }
    .status-msg { font-weight: bold; margin-left: 10px; color: #1f7ae0; }
    .muted { color: #666; font-size: 0.85rem; margin-top: 5px; }
  </style>
</head>
<body>

  <h1>Kinase Interaction Fingerprint Heatmap</h1>

  <div class="panel">
    <h2>1. 載入資料</h2>
    <div class="flex-row">
      <div class="field">
        <label>上傳 Excel (.xlsx)</label>
        <input type="file" id="fileInput" accept=".xlsx" />
      </div>
      <div class="field">
        <label>Meta 行數 (標頭)</label>
        <input type="number" id="metaRows" value="5" min="1" />
      </div>
      <button id="processBtn" disabled>執行自動辨識與分析</button>
      <span id="statusText" class="status-msg">初始化資源中...</span>
    </div>
    <div class="field" style="margin-top:10px;">
      <input type="checkbox" id="collapseHpHb" checked />
      <label style="display:inline;" for="collapseHpHb">整合 IFP 1-3 (HP) 與 4-7 (HB)</label>
      <div class="muted">勾選：顯示 1-HP, 1-HB | 取消：顯示原始格式 (1-1, 1-2...)</div>
    </div>
  </div>

  <div class="panel">
    <h2>2. 篩選與選擇 Kinase</h2>
    <div class="flex-row">
      <div class="field">
        <label>Family 篩選</label>
        <select id="familyFilter" style="min-width: 150px;"><option value="">全部</option></select>
      </div>
      <div class="field">
        <label>Group 篩選</label>
        <select id="groupFilter" style="min-width: 150px;"><option value="">全部</option></select>
      </div>
    </div>
    
    <div class="dual-list-container">
      <div class="dual-list-column">
        <label>可選 Kinase</label>
        <input type="text" id="kinaseSearch" placeholder="搜尋名稱..." style="margin-bottom:5px;">
        <select id="availableKinases" multiple class="dual-list-select"></select>
      </div>
      <div class="dual-list-column" style="flex:0; justify-content:center; gap:10px;">
        <button id="addKinaseBtn"> &gt;&gt; </button>
        <button id="removeKinaseBtn"> &lt;&lt; </button>
      </div>
      <div class="dual-list-column">
        <label>已選 Kinase (Heatmap 顯示對象)</label>
        <select id="selectedKinases" multiple class="dual-list-select"></select>
      </div>
    </div>
    <button id="updatePlotBtn" style="margin-top:1rem;" disabled>更新 Heatmap 視圖</button>
  </div>

  <div class="panel">
    <div class="flex-row" style="justify-content: space-between;">
      <h2>3. Heatmap 與數據統計</h2>
      <div>
        <button id="downloadCsvBtn" disabled>下載目前資料 (CSV)</button>
        <button id="downloadPngBtn" disabled>下載圖片 (PNG)</button>
      </div>
    </div>
    <div id="heatmap"></div>
    <h3 style="margin-top:20px;">交互作用特徵 (Feature) 平均發生率</h3>
    <div id="featureStatsContainer"></div>
  </div>

  <script>
    const CONFIG = {
      IFP_XLSX_URL: "https://raw.githubusercontent.com/CharlieYang-gif/KLIFS_heatmap/main/20241001_KLIFS_IFP595_ID.xlsx",
      META_CSV_URL: "https://raw.githubusercontent.com/CharlieYang-gif/KLIFS_heatmap/main/KLIFS_export.csv"
    };

    let rawData = null; 
    let kinaseFreqMatrix = null;
    let featureNames = [];
    let kinaseNames = [];
    let kinaseMetaMap = {}; 
    let kinaseColIndex = 2; // 預設第三欄

    const el = (id) => document.getElementById(id);
    const ui = {
      fileInput: el("fileInput"),
      processBtn: el("processBtn"),
      status: el("statusText"),
      available: el("availableKinases"),
      selected: el("selectedKinases"),
      search: el("kinaseSearch"),
      family: el("familyFilter"),
      group: el("groupFilter"),
      heatmap: el("heatmap")
    };

    // 自動偵測包含 "IFP" 的欄位
    function getIfpColumnIndices(headerRow) {
      return headerRow.reduce((acc, cell, idx) => {
        if (cell && String(cell).toUpperCase().includes("IFP")) acc.push(idx);
        return acc;
      }, []);
    }

    // 格式化 Feature 名稱 (0-1 -> 1-1)
    function formatIfpName(rawName) {
      if (!rawName || !rawName.includes('-')) return rawName;
      const parts = rawName.split('-');
      const pos = parseInt(parts[0]) + 1;
      return `${pos}-${parts[1]}`;
    }

    // 排序 Feature (數字優先排序)
    function sortFeatures(features) {
      return features.sort((a, b) => {
        const parse = (s) => {
          const m = s.match(/^(\d+)-(.*)$/);
          return m ? [parseInt(m[1]), m[2]] : [Infinity, s];
        };
        const [aPos, aType] = parse(a);
        const [bPos, bType] = parse(b);
        if (aPos !== bPos) return aPos - bPos;
        return aType.localeCompare(bType);
      });
    }

    function processData() {
      if (!rawData) return;
      const nMetaRows = parseInt(el("metaRows").value) || 5;
      const collapse = el("collapseHpHb").checked;
      const headerRow = rawData[0];
      const ifpIndices = getIfpColumnIndices(headerRow);

      // 自動尋找 Kinase 名稱欄位
      const kIdx = headerRow.findIndex(h => h && h.toLowerCase() === 'kinase');
      kinaseColIndex = kIdx !== -1 ? kIdx : 2;

      if (ifpIndices.length === 0) {
        alert("找不到包含 'IFP' 的欄位！");
        return;
      }

      let processedRows = [];
      const posRow = rawData[1];
      const typeRow = rawData[2];
      const nameRow = rawData[3];

      for (let i = nMetaRows; i < rawData.length; i++) {
        const row = rawData[i];
        if (!row || !row[kinaseColIndex]) continue;
        
        let obj = { kinase: String(row[kinaseColIndex]) }; 
        
        ifpIndices.forEach(idx => {
          const val = parseInt(row[idx]) || 0;
          if (collapse) {
            const pos = parseInt(posRow[idx]) + 1;
            const type = parseInt(typeRow[idx]);
            const key = [1, 2, 3].includes(type) ? `${pos}-HP` : `${pos}-HB`;
            obj[key] = (obj[key] || 0) | val;
          } else {
            const key = formatIfpName(nameRow[idx]);
            obj[key] = val;
          }
        });
        processedRows.push(obj);
      }

      const grouped = processedRows.reduce((acc, row) => {
        if (!acc[row.kinase]) acc[row.kinase] = [];
        acc[row.kinase].push(row);
        return acc;
      }, {});

      const allFeatures = Object.keys(processedRows[0]).filter(k => k !== 'kinase');
      featureNames = sortFeatures(allFeatures);
      
      kinaseFreqMatrix = Object.keys(grouped).map(k => {
        let res = { kinase: k };
        allFeatures.forEach(f => {
          const sum = grouped[k].reduce((s, r) => s + (r[f] || 0), 0);
          res[f] = (sum / grouped[k].length) * 100;
        });
        return res;
      });

      kinaseNames = Object.keys(grouped).sort();
      updateKinaseLists();
      el("updatePlotBtn").disabled = false;
      el("downloadCsvBtn").disabled = false;
      el("downloadPngBtn").disabled = false;
      ui.status.textContent = "分析與標籤格式化完成";
      drawHeatmap();
    }

    function updateKinaseLists() {
      const query = ui.search.value.toLowerCase();
      const selSet = new Set(Array.from(ui.selected.options).map(o => o.value));
      const curFam = ui.family.value;
      const curGrp = ui.group.value;

      ui.available.innerHTML = "";
      kinaseNames.forEach(k => {
        if (selSet.has(k)) return;
        if (query && !k.toLowerCase().includes(query)) return;
        const meta = kinaseMetaMap[k] || {};
        if (curFam && meta.family !== curFam) return;
        if (curGrp && meta.group !== curGrp) return;
        ui.available.add(new Option(k, k));
      });
    }

    function drawHeatmap() {
      const selected = Array.from(ui.selected.options).map(o => o.value);
      const dataRows = (selected.length > 0 ? 
        kinaseFreqMatrix.filter(r => selected.includes(r.kinase)) : 
        kinaseFreqMatrix).filter(r => {
          const meta = kinaseMetaMap[r.kinase] || {};
          return (!ui.family.value || meta.family === ui.family.value) &&
                 (!ui.group.value || meta.group === ui.group.value);
        });

      if (dataRows.length === 0) {
        Plotly.purge(ui.heatmap);
        return;
      }

      const z = dataRows.map(r => featureNames.map(f => r[f]));
      const y = dataRows.map(r => r.kinase);

      const trace = {
        z: z, x: featureNames, y: y,
        type: 'heatmap', colorscale: 'Viridis',
        colorbar: { title: 'Freq %' }
      };

      const layout = {
        title: 'Kinase Interaction Frequency Heatmap',
        xaxis: { tickangle: -90, automargin: true, title: 'Interaction Feature (Position-Type)' },
        yaxis: { automargin: true, title: 'Kinase' },
        height: Math.max(600, y.length * 20 + 200),
        margin: { t: 50, b: 100 }
      };

      Plotly.newPlot(ui.heatmap, [trace], layout, {responsive: true});
      renderStats(dataRows);
    }

    function renderStats(rows) {
      const stats = featureNames.map(f => {
        const avg = rows.reduce((s, r) => s + r[f], 0) / rows.length;
        return { feature: f, avg: avg };
      }).sort((a,b) => b.avg - a.avg);

      let html = "<table><tr><th>Interaction Feature</th><th>平均發生率 (Mean %)</th></tr>";
      stats.slice(0, 100).forEach(s => {
        html += `<tr><td>${s.feature}</td><td>${s.avg.toFixed(1)}%</td></tr>`;
      });
      el("featureStatsContainer").innerHTML = html + "</table>";
    }

    // 初始化與檔案解析
    async function loadResources() {
      ui.status.textContent = "讀取伺服器資源中...";
      try {
        const [ifpRes, metaRes] = await Promise.all([
          fetch(CONFIG.IFP_XLSX_URL).then(r => r.arrayBuffer()),
          fetch(CONFIG.META_CSV_URL).then(r => r.text())
        ]);
        
        // 1. 解析 KLIFS_export.csv (修正分隔符號偵測)
        const delimiter = metaRes.includes('\t') ? '\t' : (metaRes.includes(';') ? ';' : ',');
        const metaLines = metaRes.split(/\r?\n/).filter(l => l.trim());
        const header = metaLines[0].split(delimiter).map(s => s.trim().toUpperCase());
        
        const iN = header.indexOf("NAME"), iF = header.indexOf("FAMILY"), iG = header.indexOf("GROUPS");
        const families = new Set(), groups = new Set();
        
        metaLines.slice(1).forEach(l => {
          const cols = l.split(delimiter).map(s => s.trim());
          if (!cols[iN]) return;
          kinaseMetaMap[cols[iN]] = { family: cols[iF] || "", group: cols[iG] || "" };
          if (cols[iF]) families.add(cols[iF]);
          if (cols[iG]) groups.add(cols[iG]);
        });
        
        // 2. 填充 Family/Group 選單
        Array.from(families).sort().forEach(f => ui.family.add(new Option(f, f)));
        Array.from(groups).sort().forEach(g => ui.group.add(new Option(g, g)));

        // 3. 解析 Excel
        const wb = XLSX.read(ifpRes, {type:'array'});
        rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        
        ui.processBtn.disabled = false;
        ui.status.textContent = "所有資源載入成功";
      } catch (e) {
        console.error(e);
        ui.status.textContent = "網路資源讀取失敗，請手動上傳 Excel。";
      }
    }

    ui.fileInput.onchange = (e) => {
      const reader = new FileReader();
      reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'array'});
        rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        ui.processBtn.disabled = false;
        ui.status.textContent = "本機 Excel 已準備就緒";
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    };

    ui.processBtn.onclick = processData;
    ui.updatePlotBtn.onclick = drawHeatmap;
    ui.search.oninput = updateKinaseLists;
    ui.family.onchange = updateKinaseLists;
    ui.group.onchange = updateKinaseLists;
    
    el("addKinaseBtn").onclick = () => {
      Array.from(ui.available.selectedOptions).forEach(o => ui.selected.add(new Option(o.text, o.value)));
      updateKinaseLists();
    };
    el("removeKinaseBtn").onclick = () => {
      Array.from(ui.selected.selectedOptions).forEach(o => o.remove());
      updateKinaseLists();
    };

    el("downloadCsvBtn").onclick = () => {
        let csv = "kinase," + featureNames.join(",") + "\n";
        kinaseFreqMatrix.forEach(r => {
            csv += r.kinase + "," + featureNames.map(f => r[f].toFixed(2)).join(",") + "\n";
        });
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "kinase_ifp_analysis.csv"; a.click();
    };

    el("downloadPngBtn").onclick = () => {
        Plotly.downloadImage(ui.heatmap, {format:'png', filename:'kinase_heatmap', width: 1600, height: 1000});
    };

    loadResources();
  </script>
</body>
</html>
