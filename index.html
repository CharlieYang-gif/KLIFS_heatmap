<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Kinase IFP Heatmap Tool_V4_Final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem 2rem; background: #f5f5f5; color: #333; }
    .panel { background: #fff; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #1f7ae0; margin-top: 0; }
    .flex-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .field { margin-bottom: 0.5rem; }
    label { font-weight: 600; display: block; margin-bottom: 4px; }
    select, input, button { padding: 0.6rem; border-radius: 6px; border: 1px solid #ccc; font-size: 0.9rem; }
    button { cursor: pointer; background: #1f7ae0; color: white; border: none; font-weight: 600; transition: 0.2s; }
    button:hover { background: #155cb0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .dual-list-container { display: flex; gap: 1rem; margin-top: 1rem; }
    .dual-list-column { flex: 1; display: flex; flex-direction: column; }
    .dual-list-select { min-height: 300px; width: 100%; overflow-y: auto; }
    #heatmap { width: 100%; min-height: 600px; margin-top: 1rem; border: 1px solid #eee; }
    table { border-collapse: collapse; width: 100%; display: block; max-height: 400px; overflow: auto; border: 1px solid #ddd; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; text-align: center; }
    th { background: #f8f9fa; position: sticky; top: 0; }
    .status-msg { font-weight: bold; margin-left: 10px; color: #e67e22; }
  </style>
</head>
<body>

  <h1>Kinase Interaction Heatmap Tool</h1>

  <div class="panel">
    <h2>1. 數據載入與辨識</h2>
    <div class="flex-row">
      <div class="field">
        <label>上傳 Excel (.xlsx)</label>
        <input type="file" id="fileInput" accept=".xlsx" />
      </div>
      <button id="processBtn" disabled>執行全自動分析</button>
      <span id="statusText" class="status-msg">初始化資源中...</span>
    </div>
    <div class="field" style="margin-top:10px;">
      <input type="checkbox" id="collapseHpHb" checked />
      <label style="display:inline;" for="collapseHpHb">整合 IFP 特徵 (HP/HB 模式)</label>
    </div>
  </div>

  <div class="panel">
    <h2>2. Family / Group 篩選與 Kinase 選擇</h2>
    <div class="flex-row">
      <div class="field">
        <label>Family 篩選</label>
        <select id="familyFilter"><option value="">全部 Family</option></select>
      </div>
      <div class="field">
        <label>Group 篩選</label>
        <select id="groupFilter"><option value="">全部 Group</option></select>
      </div>
    </div>
    
    <div class="dual-list-container">
      <div class="dual-list-column">
        <label>待選清單 (可用滑鼠點擊或搜尋)</label>
        <input type="text" id="kinaseSearch" placeholder="輸入關鍵字篩選名稱..." style="margin-bottom:5px;">
        <select id="availableKinases" multiple class="dual-list-select"></select>
      </div>
      <div class="dual-list-column" style="flex:0; justify-content:center; gap:10px;">
        <button id="addKinaseBtn" title="加入選中項目"> ➔ </button>
        <button id="removeKinaseBtn" title="移除選中項目"> ⬅ </button>
      </div>
      <div class="dual-list-column">
        <label>已選清單 (將呈現在圖表中)</label>
        <select id="selectedKinases" multiple class="dual-list-select"></select>
      </div>
    </div>
    <button id="updatePlotBtn" style="margin-top:1rem; width:100%;" disabled>更新圖表視圖</button>
  </div>

  <div class="panel">
    <div class="flex-row" style="justify-content: space-between;">
      <h2>3. 分析結果</h2>
      <div>
        <button id="downloadCsvBtn" disabled>下載數據 (CSV)</button>
        <button id="downloadPngBtn" disabled>下載圖檔 (PNG)</button>
      </div>
    </div>
    <div id="heatmap"></div>
    <div id="featureStatsContainer" style="margin-top:20px;"></div>
  </div>

  <script>
    const CONFIG = {
      IFP_XLSX_URL: "https://raw.githubusercontent.com/CharlieYang-gif/KLIFS_heatmap/main/20241001_KLIFS_IFP595_ID.xlsx",
      META_CSV_URL: "https://raw.githubusercontent.com/CharlieYang-gif/KLIFS_heatmap/main/KLIFS_export.csv"
    };

    let rawData = null; 
    let kinaseFreqMatrix = null;
    let featureNames = [];
    let kinaseNames = [];
    let kinaseMetaMap = {}; // { "CAMK2A": { family: "CAMK2", group: "CAMK" } }

    const ui = {
      available: document.getElementById("availableKinases"),
      selected: document.getElementById("selectedKinases"),
      family: document.getElementById("familyFilter"),
      group: document.getElementById("groupFilter"),
      status: document.getElementById("statusText")
    };

    // 解析 Meta CSV 並強化匹配邏輯
    function parseMetaCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) return;

      const delimiter = text.includes('\t') ? '\t' : ',';
      const header = lines[0].split(delimiter).map(s => s.trim().toUpperCase());
      
      const idxN = header.indexOf("NAME"), idxF = header.indexOf("FAMILY"), idxG = header.indexOf("GROUPS");
      const families = new Set(), groups = new Set();

      lines.slice(1).forEach(l => {
        const cols = l.split(delimiter).map(s => s.trim());
        let rawName = cols[idxN];
        if (!rawName) return;

        // 處理如 "CAMK2A (CaMK2a)" 這種帶括號的名稱，提取主名稱
        let cleanName = rawName.split('(')[0].trim().toUpperCase();
        let meta = { family: cols[idxF] || "Other", group: cols[idxG] || "Other" };
        
        kinaseMetaMap[cleanName] = meta;
        kinaseMetaMap[rawName.toUpperCase()] = meta; // 同時保留原名匹配

        if (meta.family) families.add(meta.family);
        if (meta.group) groups.add(meta.group);
      });

      // 更新選單
      updateFilterUI("familyFilter", Array.from(families).sort());
      updateFilterUI("groupFilter", Array.from(groups).sort());
    }

    function updateFilterUI(id, list) {
      const select = document.getElementById(id);
      list.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        select.appendChild(opt);
      });
    }

    // 數據處理：自動偵測 IFP 欄位與格式化標籤
    function processExcel() {
      if (!rawData) return;
      const nMetaRows = 5;
      const collapse = document.getElementById("collapseHpHb").checked;
      const header = rawData[0];
      const ifpCols = header.reduce((a, c, i) => (c && String(c).toUpperCase().includes("IFP") ? [...a, i] : a), []);
      const kIdx = header.findIndex(h => h && h.toLowerCase().includes("kinase")) || 2;

      let tempRows = [];
      for (let i = nMetaRows; i < rawData.length; i++) {
        const row = rawData[i];
        if (!row || !row[kIdx]) continue;
        
        let kName = String(row[kIdx]).toUpperCase();
        let obj = { kinase: kName };
        
        ifpCols.forEach(idx => {
          const val = parseInt(row[idx]) || 0;
          if (collapse) {
            const pos = parseInt(rawData[1][idx]) + 1;
            const type = parseInt(rawData[2][idx]);
            const key = [1, 2, 3].includes(type) ? `${pos}-HP` : `${pos}-HB`;
            obj[key] = (obj[key] || 0) | val;
          } else {
            const rawKey = rawData[3][idx]; // IFP_name
            const pos = parseInt(rawKey.split('-')[0]) + 1;
            const bit = rawKey.split('-')[1];
            obj[`${pos}-${bit}`] = val;
          }
        });
        tempRows.push(obj);
      }

      // 分組計算頻率
      const grouped = tempRows.reduce((a, r) => {
        if (!a[r.kinase]) a[r.kinase] = [];
        a[r.kinase].push(r);
        return a;
      }, {});

      const features = Object.keys(tempRows[0]).filter(k => k !== 'kinase').sort((a,b) => parseInt(a) - parseInt(b));
      featureNames = features;
      
      kinaseFreqMatrix = Object.keys(grouped).map(k => {
        let res = { kinase: k };
        features.forEach(f => {
          const sum = grouped[k].reduce((s, r) => s + (r[f] || 0), 0);
          res[f] = (sum / grouped[k].length) * 100;
        });
        return res;
      });

      kinaseNames = Object.keys(grouped).sort();
      refreshKinaseList();
      document.getElementById("updatePlotBtn").disabled = false;
      ui.status.textContent = "分析完成，請選擇 Kinase。";
    }

    function refreshKinaseList() {
      const search = document.getElementById("kinaseSearch").value.toUpperCase();
      const fam = ui.family.value;
      const grp = ui.group.value;
      const selectedSet = new Set(Array.from(ui.selected.options).map(o => o.value));

      ui.available.innerHTML = "";
      kinaseNames.forEach(k => {
        if (selectedSet.has(k)) return;
        const meta = kinaseMetaMap[k] || { family: "Other", group: "Other" };
        
        const matchSearch = !search || k.includes(search);
        const matchFam = !fam || meta.family === fam;
        const matchGrp = !grp || meta.group === grp;

        if (matchSearch && matchFam && matchGrp) {
          ui.available.add(new Option(k, k));
        }
      });
    }

    // 事件監聽
    document.getElementById("addKinaseBtn").onclick = () => {
      Array.from(ui.available.selectedOptions).forEach(o => ui.selected.add(new Option(o.text, o.value)));
      refreshKinaseList();
    };
    document.getElementById("removeKinaseBtn").onclick = () => {
      Array.from(ui.selected.selectedOptions).forEach(o => o.remove());
      refreshKinaseList();
    };
    document.getElementById("updatePlotBtn").onclick = drawHeatmap;
    document.getElementById("kinaseSearch").oninput = refreshKinaseList;
    ui.family.onchange = refreshKinaseList;
    ui.group.onchange = refreshKinaseList;

    function drawHeatmap() {
      const selected = Array.from(ui.selected.options).map(o => o.value);
      if (selected.length === 0) { alert("請先從左側選擇 Kinase 加入右側已選清單。"); return; }

      const dataRows = kinaseFreqMatrix.filter(r => selected.includes(r.kinase));
      const z = dataRows.map(r => featureNames.map(f => r[f]));
      const y = dataRows.map(r => r.kinase);

      const data = [{ z: z, x: featureNames, y: y, type: 'heatmap', colorscale: 'Viridis' }];
      const layout = { 
        title: 'Kinase Interaction Frequency (%)',
        xaxis: { tickangle: -90, automargin: true },
        yaxis: { automargin: true },
        height: Math.max(600, y.length * 25 + 200)
      };

      Plotly.newPlot('heatmap', data, layout);
      document.getElementById("downloadCsvBtn").disabled = false;
      document.getElementById("downloadPngBtn").disabled = false;
    }

    async function init() {
      try {
        const [ifpRes, metaRes] = await Promise.all([
          fetch(CONFIG.IFP_XLSX_URL).then(r => r.arrayBuffer()),
          fetch(CONFIG.META_CSV_URL).then(r => r.text())
        ]);
        parseMetaCSV(metaRes);
        const wb = XLSX.read(ifpRes, {type:'array'});
        rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        document.getElementById("processBtn").disabled = false;
        ui.status.textContent = "資源載入成功，可上傳檔案或直接分析。";
      } catch (e) {
        ui.status.textContent = "網路資源失敗，請手動檢查。";
      }
    }

    document.getElementById("fileInput").onchange = (e) => {
      const reader = new FileReader();
      reader.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'array'});
        rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        document.getElementById("processBtn").disabled = false;
        ui.status.textContent = "本機檔案上傳成功";
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    };

    document.getElementById("processBtn").onclick = processExcel;

    init();
  </script>
</body>
</html>
